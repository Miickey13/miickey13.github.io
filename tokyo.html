<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Seoul Map ‚Äî Tokyo-style Filters</title>

  <!-- Same library stack as before -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>

  <style>
    html, body {height:100%; margin:0;}
    #map {position:absolute; inset:0;}

    /* Keep popups above the side panel */
    .leaflet-pane.leaflet-popup-pane { z-index: 3000 !important; }

    /* Side panel */
    #sidePanel{
      position:absolute; left:10px; top:10px; z-index:1200;
      width:300px; max-width:90vw; background:#fff; border-radius:12px;
      border:1px solid #e8e8e8; box-shadow:0 6px 24px rgba(0,0,0,.18);
      overflow:hidden; transition: top .18s ease, width .18s ease, border-radius .18s ease;
    }
    #panelHeader{
      background:#111; color:#fff; padding:8px 10px; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      -webkit-tap-highlight-color: transparent;
    }
    #panelHeader .title{ display:flex; align-items:center; gap:8px; }
    #panelHeader h4{ margin:0; font-size:15px; font-weight:600; }
    #panelHeader .mini{ display:none; }

    #panelBody{ padding:10px 12px; }
    #panelFooter{ padding:10px 12px; border-top:1px solid #eee; display:flex; gap:6px; flex-wrap:wrap; }

    #panelFooter button{ border:0; border-radius:8px; padding:6px 10px; background:#111; color:#fff; }
    #panelFooter button.alt{ background:#666; }
    #panelFooter button.ghost{ background:#fff; color:#111; border:1px solid #ddd; }

    /* Category list like Tokyo */
    .cat-heading{ font-weight:700; margin:0 0 6px; font-size:16px; }
    .cat-list{ list-style:none; padding:0; margin:0; }
    .cat-list li{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .cat-list .emoji{ width:20px; text-align:center; }
    .cat-list label{ font-weight:400; margin:0; cursor:pointer; }
    .legend-box{ margin-top:8px; font-size:12px; color:#444; }
    .legend-box b{ font-weight:700; }
    .legend-dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin:0 4px; vertical-align:middle; }
    .legend-gold{ background:linear-gradient(180deg,#ffdc73,#e2a500); border:1px solid #c89200; }
    .legend-blue{ background:#3388ff; border:1px solid #1d5fcc; }
    .legend-green{ background:#43a047; border:1px solid #2e7d32; }

    /* Collapsed (icon-only, moved lower to avoid map controls) */
    #sidePanel.collapsed{ width:52px; border-radius:12px; top:74px; }
    #sidePanel.collapsed #panelBody,
    #sidePanel.collapsed #panelFooter,
    #sidePanel.collapsed #panelHeader .title { display:none !important; }
    #sidePanel.collapsed #panelHeader .mini { display:inline-block; }

    /* Popup visuals */
    .leaflet-popup-content{ margin:8px 12px; }
    .popup-img{ width:100%; height:auto; border-radius:8px; margin-bottom:6px; object-fit:cover; }

    /* Mobile-friendly popups and panel behavior */
    @media (max-width:560px){
      /* Panel: allow expand/collapse rather than forcing hidden */
      #sidePanel{ width:86vw; top:74px; }         /* wide when expanded */
      #sidePanel.collapsed{ width:52px; }         /* small when collapsed */
      /* Popups should never exceed viewport width */
      .leaflet-popup { max-width:92vw !important; }
      .leaflet-popup-content-wrapper { max-width:92vw !important; }
      .nav.nav-tabs>li>a { padding:6px 8px; font-size:12px; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- TOKYO-style filter panel -->
<div id="sidePanel">
  <div id="panelHeader" title="–°–∫—Ä–∏–π/–ø–æ–∫–∞–∂–∏ —Ñ–∏–ª—Ç—Ä–∏—Ç–µ">
    <div class="title">
      <span class="glyphicon glyphicon-filter" aria-hidden="true"></span>
      <h4>–§–∏–ª—Ç—ä—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
    </div>
    <span class="mini glyphicon glyphicon-filter" aria-hidden="true" title="–§–∏–ª—Ç—Ä–∏"></span>
    <span class="glyphicon glyphicon-menu-up" id="collapseIcon" aria-hidden="true" title="–°–∫—Ä–∏–π"></span>
  </div>

  <div id="panelBody">
    <ul class="cat-list">
      <li><span class="emoji">üõï</span><label><input type="checkbox" class="catFilter" value="temple" checked> –•—Ä–∞–º–æ–≤–µ/–°–≤–µ—Ç–∏–ª–∏—â–∞</label></li>
      <li><span class="emoji">üóº</span><label><input type="checkbox" class="catFilter" value="view" checked> –õ–∞–Ω–¥–º–∞—Ä–∫–∏/–û–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏–∏</label></li>
      <li><span class="emoji">üå≥</span><label><input type="checkbox" class="catFilter" value="park" checked> –ì—Ä–∞–¥–∏–Ω–∏/–ü–∞—Ä–∫–æ–≤–µ</label></li>
      <li><span class="emoji">üßÜ</span><label><input type="checkbox" class="catFilter" value="market" checked> –ü–∞–∑–∞—Ä–∏/–•—Ä–∞–Ω–∞</label></li>
      <li><span class="emoji">üèôÔ∏è</span><label><input type="checkbox" class="catFilter" value="district" checked> –ö–≤–∞—Ä—Ç–∞–ª–∏</label></li>
      <li><span class="emoji">üñºÔ∏è</span><label><input type="checkbox" class="catFilter" value="museum" checked> –ú—É–∑–µ–∏/–ò–∑–∫—É—Å—Ç–≤–æ</label></li>
      <li><span class="emoji">üè∞</span><label><input type="checkbox" class="catFilter" value="palace" checked> –î–≤–æ—Ä—Ü–∏/–ù–∞—Å–ª–µ–¥—Å—Ç–≤–æ</label></li>
      <li><span class="emoji">üè®</span><label><input type="checkbox" class="catFilter" value="hotel" checked> –•–æ—Ç–µ–ª–∏</label></li>
      <li><span class="emoji">‚úö</span><label><input type="checkbox" class="catFilter" value="other" checked> –î—Ä—É–≥–æ</label></li>
    </ul>

    <div style="margin-top:10px;">
      <label><input type="checkbox" id="onlyTop"> –°–∞–º–æ –¢–æ–ø 10</label>
    </div>

    <div class="legend-box">
      <p><b>‚Ä¢</b> <span class="legend-dot legend-gold"></span> –ó–ª–∞—Ç–µ–Ω –ø–∏–Ω = –¢–æ–ø 10 –°–µ—É–ª</p>
      <p><b>‚Ä¢</b> <span class="legend-dot legend-blue"></span> –°–∏–Ω –ø–∏–Ω = –¥—Ä—É–≥–∏ –º–µ—Å—Ç–∞</p>
      <p><b>‚Ä¢</b> <span class="legend-dot legend-green"></span> –ó–µ–ª–µ–Ω –ø–∏–Ω = —Ö–æ—Ç–µ–ª</p>
    </div>
  </div>

  <div id="panelFooter">
    <button id="btnLocate" title="–ü–æ–∫–∞–∂–∏ —Ç–µ–∫—É—â–∞—Ç–∞ –º–∏ –ª–æ–∫–∞—Ü–∏—è">–ù–∞–º–µ—Ä–∏ –º–µ</button>
    <button class="alt" id="btnFit" title="–ü–æ–±–µ—Ä–∏ –≤—Å–∏—á–∫–∏ –º–∞—Ä–∫–µ—Ä–∏">–ü–æ–±–µ—Ä–∏ –≤—Å–∏—á–∫–∏</button>
    <button class="ghost" id="btnReset" title="–ù—É–ª–∏—Ä–∞–π —Ñ–∏–ª—Ç—Ä–∏—Ç–µ">–ù—É–ª–∏—Ä–∞–π</button>
  </div>
</div>

<script>
  // Base map
  var map = L.map('map', { center:[37.5665,126.978], zoom:12, zoomControl:true, preferCanvas:false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'Data ¬© <a href="http://openstreetmap.org">OpenStreetMap</a> (ODbL)', maxZoom:19
  }).addTo(map);

  // Icons
  const goldIcon  = L.AwesomeMarkers.icon({icon:'star', prefix:'glyphicon', markerColor:'orange', iconColor:'#fff'});
  const blueIcon  = L.AwesomeMarkers.icon({icon:'info-sign', prefix:'glyphicon', markerColor:'blue',   iconColor:'#fff'});
  const hotelIcon = L.AwesomeMarkers.icon({icon:'home',     prefix:'glyphicon', markerColor:'green',  iconColor:'#fff'});

  // Utils
  const HOTEL = { name:"Your Hotel (23-1 Eulji-ro 19-gil, Jung-gu)", lat:37.569243, lng:126.995227, category:'hotel' };
  let currentLoc = null, currentDot = null;

  // Robust Commons redirect (works for any exact filename)
  function commons(file){ return 'https://commons.wikimedia.org/wiki/Special:FilePath/' + encodeURIComponent(file) + '?width=640'; }

  function gmDirections(origin, lat, lng, mode){
    return 'https://www.google.com/maps/dir/?api=1&origin=' + encodeURIComponent(origin) +
           '&destination=' + encodeURIComponent(lat+','+lng) + '&travelmode=' + mode;
  }
  function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-'); }

  // --- DATA (Top 10 = gold) ---
  const top10 = [
    {title:"Gyeongbokgung Palace", lat:37.5796, lng:126.9770, category:"palace", top:true,
     img:commons("Gyeonghoeru_Pavilion_in_Gyeongbokgung_Palace.jpg"), wiki:"https://en.wikipedia.org/wiki/Gyeongbokgung",
     info_bg:"–ò–∑–¥–∏–≥–Ω–∞—Ç –ø—Ä–µ–∑ 1395 –≥. –∫–∞—Ç–æ –ø—ä—Ä–≤–∏ –∏ ‚Äû–≥–ª–∞–≤–µ–Ω‚Äú –¥–≤–æ—Ä–µ—Ü –Ω–∞ –¥–∏–Ω–∞—Å—Ç–∏—è –ß–æ—Å–æ–Ω. –û–ø–æ–∂–∞—Ä–µ–Ω –ø—Ä–∏ –ò–º–¥–∂–∏–Ω—Å–∫–∞—Ç–∞ –≤–æ–π–Ω–∞ (1592), –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω –æ—Ç 1865 –≥.; –º–∞—Å–æ–≤–∏ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ –Ω–∞ —è–ø–æ–Ω—Å–∫–∞—Ç–∞ –æ–∫—É–ø–∞—Ü–∏—è. –î–Ω–µ—Å —Å–µ —Ä–µ—Å—Ç–∞–≤—Ä–∏—Ä–∞ –∫—ä–º –≤–∏–¥–∞ –æ—Ç 1888 –≥. –ì–ª–∞–≤–Ω–∞—Ç–∞ –ø–æ—Ä—Ç–∞ –ì—É–∞–Ω—Ö–≤–∞–º—É–Ω –µ —Ä–µ—Å—Ç–∞–≤—Ä–∏—Ä–∞–Ω–∞ –ø—Ä–µ–∑ 2010 –≥., –∞ –∫–∞–º–µ–Ω–Ω–∞—Ç–∞ –π —Ç–µ—Ä–∞—Å–∞ ‚Äì 2023 –≥. –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π—Ç–µ —Å–º—è–Ω–∞—Ç–∞ –Ω–∞ –∫–∞—Ä–∞—É–ª–∞ –∏ –ù–∞—Ü–∏–æ–Ω–∞–ª–Ω–∏—è —Ñ–æ–ª–∫–ª–æ—Ä–µ–Ω –º—É–∑–µ–π.",
     official:"https://www.royalpalace.go.kr/",
     photoIdeas:["–ì—É–∞–Ω–≥—Ö–≤–∞–º—É–Ω –∏ —Ü–µ—Ä–µ–º–æ–Ω–∏—è—Ç–∞ –Ω–∞ –∫–∞—Ä–∞—É–ª–∞","–ï–∑–µ—Ä—Ü–∞ –∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–≤–∏–ª–∏–æ–Ω–∏—Ç–µ","–ù–æ—â–Ω–∏ –æ—Å–≤–µ—Ç–µ–Ω–∏ –¥–≤–æ—Ä–æ–≤–µ"],
     imgIdeas:["Gyeongbokgung guards ceremony","Gyeongbokgung night illumination","Gyeongbokgung pavilion reflection"]},
    {title:"Bukchon Hanok Village", lat:37.5826, lng:126.9830, category:"district", top:true,
     img:commons("Bukchon_Hanok_Village_01.jpg"), wiki:"https://en.wikipedia.org/wiki/Bukchon_Hanok_Village",
     info_bg:"–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ –∫–≤–∞—Ä—Ç–∞–ª —Å ~900 —Ö–∞–Ω–æ–∫ –∫—ä—â–∏ –º–µ–∂–¥—É –ì—å–æ–Ω–±–æ–∫–≥—É–Ω –∏ –ß–∞–Ω–¥–æ–∫–≥—É–Ω (–∫—ä—Å–µ–Ω XIX‚Äì—Ä–∞–Ω–µ–Ω XX –≤.). –ü–æ—Ä–∞–¥–∏ —Å–≤—Ä—ä—Ö—Ç—É—Ä–∏–∑—ä–º —Å–µ –ø—Ä–µ–ø–æ—Ä—ä—á–≤–∞—Ç –¥–Ω–µ–≤–Ω–∏ —á–∞—Å–æ–≤–∏ –ø–æ—è—Å–∏ –∏ —Ç–∏—à–∏–Ω–∞ ‚Äì —Ä–∞–π–æ–Ω—ä—Ç –µ –∂–∏–ª–∏—â–µ–Ω; –æ—á–∞–∫–≤–∞–π—Ç–µ —Ä–∞–±–æ—Ç–∏–ª–Ω–∏—Ü–∏, —á–∞–π–Ω–∏ –∏ –ø–∞–Ω–æ—Ä–∞–º–Ω–∏ —É–ª–∏—á–∫–∏.",
     official:"https://hanok.seoul.go.kr/",
     photoIdeas:["–•–∞–Ω–æ–∫ –ø–æ–∫—Ä–∏–≤–∏ –≤ –∑–ª–∞—Ç–µ–Ω —á–∞—Å","–ê–ª–µ–π–Ω–∏ –≥–ª–µ–¥–∫–∏ –∫—ä–º —Ö—ä–ª–º–æ–≤–µ—Ç–µ","–î–µ—Ç–∞–π–ª–∏ —Å —Ö–∞–Ω–¥–∂–∏ –∏ –¥—ä—Ä–≤–æ—Ä–µ–∑–±–∞"],
     imgIdeas:["Bukchon hanok golden hour","Bukchon alley view","Hanok details hanji"]},
    {title:"Changdeokgung & Secret Garden (Huwon)", lat:37.5794, lng:126.9910, category:"palace", top:true,
     img:commons("Korea-Seoul-Changdeokgung-31.jpg"),
     wiki:"https://en.wikipedia.org/wiki/Changdeokgung",
     info_bg:"–ß–∞–Ω–¥–æ–∫–≥—É–Ω (1405) ‚Äì –ª—é–±–∏–º –¥–≤–æ—Ä–µ—Ü –Ω–∞ –º–Ω–æ–≥–æ –≤–ª–∞–¥–µ—Ç–µ–ª–∏; –æ—Ç 1997 –≥. –≤ –Æ–ù–ï–°–ö–û –∑–∞—Ä–∞–¥–∏ —Ö–∞—Ä–º–æ–Ω–∏—è—Ç–∞ —Å —Ä–µ–ª–µ—Ñ–∞. –•—É–≤–æ–Ω (‚Äû–°–∫—Ä–∏—Ç–∞—Ç–∞ –≥—Ä–∞–¥–∏–Ω–∞‚Äú) —Ä–∞–∑–ø–æ–ª–∞–≥–∞ —Å –µ–∑–µ—Ä–æ—Ç–æ –ë—É–π–æ–Ω–≥–¥–∂–∏, –ø–∞–≤–∏–ª–∏–æ–Ω–∞ –î–∂—É—Ö–∞–º–Ω—É (1776) –∏ —Å—Ç–æ—Ç–∏—Ü–∏ –≤–µ–∫–æ–≤–Ω–∏ –¥—ä—Ä–≤–µ—Ç–∞; –ø–æ—Å–µ—â–∞–≤–∞ —Å–µ —Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è.",
     official:"https://eng.cdg.go.kr/",
     photoIdeas:["–õ–æ—Ç–æ—Å–∏ –ø—Ä–∏ –ë—É–π–æ–Ω–≥–¥–∂–∏","–ü–∞–≤–∏–ª–∏–æ–Ω–∏ —Å—Ä–µ–¥ –µ—Å–µ–Ω–Ω–∏ –∫–ª–µ–Ω–æ–≤–µ","–î–∂—É—Ö–∞–º–Ω—É –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–∞ —Ö—ä–ª–º–∞"],
     imgIdeas:["Changdeokgung Huwon autumn","Buyongji lotus pavilion","Juhamnu secret garden"]},
    {title:"Insa-dong", lat:37.5740, lng:126.9849, category:"district", top:true,
     img:commons("Insa-dong_%28%EC%9D%B8%EC%82%AC%EB%8F%99%29_-_panoramio.jpg"), wiki:"https://en.wikipedia.org/wiki/Insa-dong",
     info_bg:"–£–ª–∏—Ü–∞ Insadong-gil –∏ –∞–ª–µ–∏—Ç–µ –æ–∫–æ–ª–æ –Ω–µ—è ‚Äì –∞–Ω—Ç–∏–∫–∏, –∫–∞–ª–∏–≥—Ä–∞—Ñ–∏—è, –≥–∞–ª–µ—Ä–∏–∏ –∏ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ —á–∞–π–Ω–∏; —É–∏–∫–µ–Ω–¥–Ω–∏ —É–ª–∏—á–Ω–∏ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏—è. –ë–ª–∏–∑–æ –¥–æ –î–∂–æ–≥–µ—Å–∞ –∏ –¥–≤–æ—Ä—Ü–æ–≤–∞—Ç–∞ –∑–æ–Ω–∞.",
     official:"https://english.visitseoul.net/attractions/Insadong_/1708",
     photoIdeas:["–ö–∞–ª–∏–≥—Ä–∞—Ñ–∏ –∏ –ø–µ—á–∞—Ç–∏ ‚Äòdojang‚Äô","–•–∞–Ω–æ–∫ —á–∞–π–Ω–∏","–£–ª–∏—á–Ω–∏ –∞—Ä—Ç–∏—Å—Ç–∏ —É–∏–∫–µ–Ω–¥"],
     imgIdeas:["Insadong calligraphy","Insadong teahouse","Insadong street performance"]},
    {title:"N Seoul Tower (Namsan)", lat:37.5512, lng:126.9882, category:"view", top:true,
     img:commons("Seoul_Tower_from_Namsan_Park_(9595148285).jpg"),
     wiki:"https://en.wikipedia.org/wiki/N_Seoul_Tower",
     info_bg:"–†–∞–¥–∏–æ/–¢–í –∫—É–ª–∞ (1971) –Ω–∞ –≤—Ä—ä—Ö –ù–∞–º—Å–∞–Ω; –æ–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏–∏, –≤—ä—Ä—Ç—è—â —Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—Ç –∏ ‚ÄûLocks of Love‚Äú. –ù–∞–π-–¥–æ–±—Ä–æ –≤—Ä–µ–º–µ ‚Äì –ø–æ –∑–∞–ª–µ–∑; –¥–æ –±–∞–∑–∞—Ç–∞: –≤—ä–∂–µ–Ω–∞ –ª–∏–Ω–∏—è/–∞–≤—Ç–æ–±—É—Å/–ø–µ—à–∞.",
     official:"https://www.seoultower.co.kr/eng/",
     photoIdeas:["–ù–æ—â–Ω–∏ –ø–∞–Ω–æ—Ä–∞–º–∏ –Ω–∞ –°–µ—É–ª","–ö–∞—Ç–∏–Ω–∞—Ä–∏ –Ω–∞ –ª—é–±–æ–≤—Ç–∞","–ö–∞–¥—Ä–∏ –æ—Ç –≤—ä–∂–µ–Ω–∞—Ç–∞ –ª–∏–Ω–∏—è"],
     imgIdeas:["N Seoul Tower night","Namsan love locks","Namsan cable car view"]},
    {title:"Myeongdong", lat:37.5637, lng:126.9820, category:"district", top:true,
     img:commons("Myeong-dong_street_by_night.JPG"), wiki:"https://en.wikipedia.org/wiki/Myeong-dong",
     info_bg:"–ï–º–±–ª–µ–º–∞—Ç–∏—á–µ–Ω —Ç—ä—Ä–≥–æ–≤—Å–∫–∏ –∫–≤–∞—Ä—Ç–∞–ª –∑–∞ –º–æ–¥–∞ –∏ K-beauty —Å –º–Ω–æ–≥–æ —É–ª–∏—á–Ω–∞ —Ö—Ä–∞–Ω–∞ –≤–µ—á–µ—Ä; –∫–∞—Ç–µ–¥—Ä–∞–ª–∞ –ú—å–æ–Ω–¥–æ–Ω –∏ —à–æ—É—Ç–æ NANTA –Ω–∞–±–ª–∏–∑–æ.",
     official:"https://english.visitseoul.net/attractions/Myeongdong_/1744",
     photoIdeas:["–ù–µ–æ–Ω–æ–≤–∏ —É–ª–∏—Ü–∏ –≤–µ—á–µ—Ä","–©–∞–Ω–¥–æ–≤–µ —Å —É–ª–∏—á–Ω–∞ —Ö—Ä–∞–Ω–∞","–ö–∞—Ç–µ–¥—Ä–∞–ª–∞—Ç–∞ –≤ —Å–∏–Ω —á–∞—Å"],
     imgIdeas:["Myeongdong neon crowd","Myeongdong street food","Myeongdong Cathedral blue hour"]},
    {title:"Dongdaemun Design Plaza (DDP)", lat:37.5663, lng:127.0095, category:"museum", top:true,
     img:commons("Dongdaemun_Design_Plaza_at_night,_Seoul,_Korea.jpg"), wiki:"https://en.wikipedia.org/wiki/Dongdaemun_Design_Plaza",
     info_bg:"–ù–µ–æ—Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ–Ω –∫–æ–º–ø–ª–µ–∫—Å –Ω–∞ –ó–∞—Ö–∞ –•–∞–¥–∏–¥ (2014) ‚Äì –∏–∑–ª–æ–∂–±–∏, –°–µ–¥–º–∏—Ü–∞ –Ω–∞ –º–æ–¥–∞—Ç–∞, –Ω–æ—â–Ω–∏ –ø–∞–∑–∞—Ä–∏. –û—Ä–≥–∞–Ω–∏—á–Ω–∏ –æ–±–µ–º–∏ –æ—Ç –º–µ—Ç–∞–ª–Ω–∏ –ø–∞–Ω–µ–ª–∏ –∏ ‚Äû–º–µ—Ç–æ–Ω–∏–º–∏—á–Ω–∞‚Äú —Ñ–æ—Ä–º–∞.",
     official:"https://www.ddp.or.kr/",
     photoIdeas:["–ò–∑–≤–∏–≤–∫–∏ –Ω–∞ —Ñ–∞—Å–∞–¥–∞—Ç–∞","–ù–æ—â–Ω–∏ LED –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏–∏","–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∏ –∫–∞–¥—Ä–∏ –Ω–∞ –ø–∞–Ω–µ–ª–∏"],
     imgIdeas:["DDP curves architecture","Dongdaemun Design Plaza night","Zaha Hadid Seoul panels"]},
    {title:"Gwangjang Market", lat:37.5702, lng:127.0017, category:"market", top:true,
     img:commons("Gwangjang_Market.JPG"), wiki:"https://en.wikipedia.org/wiki/Gwangjang_Market",
     info_bg:"–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–µ–Ω –ø–∞–∑–∞—Ä (–∞—Å–æ—Ü–∏–∞—Ü–∏—è 1911) —Å —Ö–∏–ª—è–¥–∏ —â–∞–Ω–¥–æ–≤–µ –∏ –¥–µ—Å–µ—Ç–∫–∏ —Ö–∏–ª—è–¥–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏/–¥–µ–Ω. –•–∏—Ç–æ–≤–µ: –±–∏–Ω–¥–µ—Ç–µ–æ–∫, –º–∞–π—è–∫ –∫–∏–º–±–∞–ø, —é–∫—Ö–≤–µ.",
     official:"http://www.kwangjangmarket.co.kr/en/",
     photoIdeas:["–ü–ª–æ—á–∏ —Å –±–∏–Ω–¥–µ—Ç–µ–æ–∫","–¢–µ—Å–Ω–∏ –∞–ª–µ–∏ —Å—ä—Å –∑–Ω–∞—Ü–∏","–©–∞–Ω–¥–æ–≤–µ —Å –∫–∏–º–±–∞–ø"],
     imgIdeas:["Gwangjang bindaetteok","Gwangjang food alley","Mayak gimbap stall"]},
    {title:"Hongdae (Hongik Univ. area)", lat:37.5572, lng:126.9236, category:"district", top:true,
     img:commons("Hongdae_Streets.jpg"), wiki:"https://en.wikipedia.org/wiki/Hongdae_(area)",
     info_bg:"–ú–ª–∞–¥–µ–∂–∫–∞ —Å—Ü–µ–Ω–∞: —É–ª–∏—á–Ω–∏ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏—è, –∫–ª—É–±–æ–≤–µ, –∞—Ä—Ç –ø–∞–∑–∞—Ä–∏. –í–µ—á–µ—Ä —É–ª–∏—Ü–∏—Ç–µ –æ–∂–∏–≤—è–≤–∞—Ç —Å —Ç–∞–Ω—Ü–∏ –∏ –ª–∞–π–≤ –º—É–∑–∏–∫–∞.",
     official:"https://english.visitseoul.net/attractions/Hongdae_/1719",
     photoIdeas:["–ù–æ—â–Ω–∏ –∏–∑–ø—ä–ª–Ω–∏—Ç–µ–ª–∏","–ì—Ä–∞—Ñ–∏—Ç–∏/–∞—Ä—Ç —Å—Ç–µ–Ω–∏","–ò–Ω–¥–∏ –∫–∞—Ñ–µ–Ω–µ—Ç–∞"],
     imgIdeas:["Hongdae street performance","Hongdae murals","Hongdae indie cafe"]},
    {title:"Lotte World Tower (Seoul Sky)", lat:37.5131, lng:127.1028, category:"view", top:true,
     img:commons("Lotte_World_Tower_In_Jamsil_(144738473).jpeg"),
     wiki:"https://en.wikipedia.org/wiki/Lotte_World_Tower",
     info_bg:"–ù–∞–π-–≤–∏—Å–æ–∫–∞—Ç–∞ —Å–≥—Ä–∞–¥–∞ –≤ –ö–æ—Ä–µ—è (555 –º, 123 –µ—Ç.; –æ—Ç–∫—Ä–∏—Ç–∞ 2017). –û–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏—è Seoul Sky (–µ—Ç. 117‚Äì123) —Å—ä—Å —Å—Ç—ä–∫–ª–µ–Ω –ø–æ–¥ –∏ —Ç–µ—Ä–∞—Å–∞.",
     official:"https://www.lwt.co.kr/",
     photoIdeas:["–°—Ç—ä–∫–ª–µ–Ω–∏—è—Ç –ø–æ–¥ –Ω–∞ 118-–∏ –µ—Ç–∞–∂","–û—Ç—Ä–∞–∂–µ–Ω–∏–µ –≤ –µ–∑–µ—Ä–æ—Ç–æ –°–æ–∫—á–æ–Ω","–ù–æ—â–Ω–∞ –ø–∞–Ω–æ—Ä–∞–º–∞ –æ—Ç –æ–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏—è—Ç–∞"],
     imgIdeas:["Seoul Sky glass floor","Seokchon Lake reflection tower","Seoul skyline from Lotte Tower"]}
  ];

  // Others
  const others = [
    {title:"Jogyesa Temple", lat:37.5730, lng:126.9823, category:"temple", top:false,
     img:commons("Seoul-Buddhist.temple-Jogyesa-01.jpg"), wiki:"https://en.wikipedia.org/wiki/Jogyesa",
     info_bg:"–ì–ª–∞–≤–µ–Ω —Ö—Ä–∞–º –Ω–∞ –±—É–¥–∏—Å—Ç–∫–∏—è –æ—Ä–¥–µ–Ω –ß–æ–≥–µ (–∫–æ—Ä–µ–π—Å–∫–∏ –¥–∑–µ–Ω). –ü—Ä–∞–∑–Ω–∏—á–Ω–æ —É–∫—Ä–∞—Å–µ–Ω —Å —Ñ–µ–Ω–µ—Ä–∏ –æ–∫–æ–ª–æ —Ä–æ–∂–¥–µ–Ω–∏—è –¥–µ–Ω –Ω–∞ –ë—É–¥–∞; 500-–≥–æ–¥–∏—à–Ω–æ –¥—ä—Ä–≤–æ –Ω–∞ –≤—Ö–æ–¥–∞.",
     official:"https://www.jogyesa.kr/",
     photoIdeas:["–î–≤–æ—Ä —Å —Ü–≤–µ—Ç–Ω–∏ —Ñ–µ–Ω–µ—Ä–∏","–ì–ª–∞–≤–Ω–∞—Ç–∞ –∑–∞–ª–∞ Daeungjeon","–í—Ä–∞—Ç–∏ –∏ –¥–µ—Ç–∞–π–ª–∏"],
     imgIdeas:["Jogyesa lanterns","Jogyesa Daeungjeon","Jogyesa temple gate"]},
    {title:"Dongdaemun Market", lat:37.5716, lng:127.0090, category:"market", top:false,
     img:commons("Korea-Seoul-Dongdaemun_Market-01.jpg"), wiki:"https://en.wikipedia.org/wiki/Dongdaemun_Market",
     info_bg:"–û–≥—Ä–æ–º–µ–Ω —Ç—ä—Ä–≥–æ–≤—Å–∫–∏ —Ä–∞–π–æ–Ω (–æ—Ç 1905) ‚Äì —Ç–µ–∫—Å—Ç–∏–ª, –º–æ–¥–∞, –Ω–æ—â–Ω–æ –ø–∞–∑–∞—Ä—É–≤–∞–Ω–µ –≤ –¥–µ—Å–µ—Ç–∫–∏ –º–æ–ª–æ–≤–µ –∏ —Ö–∏–ª—è–¥–∏ —â–∞–Ω–¥–æ–≤–µ.",
     official:"https://english.visitseoul.net/shopping/Dongdaemun-Market_/2576",
     photoIdeas:["–ù–æ—â–Ω–∏ –≤–∏—Ç—Ä–∏–Ω–∏ –∏ —Ç–∞–±–µ–ª–∏","–ü–ª–∞—Ç–æ–≤–µ –∏ –∞–∫—Å–µ—Å–æ–∞—Ä–∏","–£–ª–∏—Ü–∞ Heunginjimun-ro"],
     imgIdeas:["Dongdaemun market fabrics","Dongdaemun night shopping","Heunginjimun-ro lights"]},
    {title:"COEX Mall & Starfield Library", lat:37.5126, lng:127.0586, category:"museum", top:false,
     img:commons("Starfield_Library_COEX_20240218.jpg"), wiki:"https://en.wikipedia.org/wiki/Starfield_Coex_Mall",
     info_bg:"–ï–¥–∏–Ω –æ—Ç –Ω–∞–π-–≥–æ–ª–µ–º–∏—Ç–µ –ø–æ–¥–∑–µ–º–Ω–∏ –º–æ–ª–æ–≤–µ –≤ –ê–∑–∏—è; –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Starfield —Å 13-–º–µ—Ç—Ä–æ–≤–∏ —Ä–∞—Ñ—Ç–æ–≤–µ –∏ >50 000 –∫–Ω–∏–≥–∏ ‚Äì –ø–æ–ø—É–ª—è—Ä–Ω–æ —Ñ–æ—Ç–æ–º—è—Å—Ç–æ.",
     official:"https://www.starfield.co.kr/coexlib/",
     photoIdeas:["–í–∏—Å–æ–∫–∏ —Ä–∞—Ñ—Ç–æ–≤–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–Ω–∏—è –ø–ª–æ—â–∞–¥","–ß–∏—Ç–∞—Ç–µ–ª–∏ –ø—Ä–µ–¥ ‚Äò–∫–Ω–∏–∂–Ω–∞—Ç–∞ —Å—Ç–µ–Ω–∞‚Äô","–°–∏–º–µ—Ç—Ä–∏—á–Ω–∏ –∫–∞–¥—Ä–∏ –æ—Ç –±–∞–ª—é—Å—Ç—Ä–∞–¥–∞—Ç–∞"],
     imgIdeas:["Starfield Library COEX shelves","COEX library wide angle","Starfield Library balcony view"]},
    {title:"Han River Park (Banpo Rainbow Fountain)", lat:37.5123, lng:126.9960, category:"park", top:false,
     img:commons("Banpo_Moonlight_Rainbow_Fountain.jpg"), wiki:"https://en.wikipedia.org/wiki/Banpo_Bridge",
     info_bg:"–®–æ—É—Ç–æ ‚ÄòMoonlight Rainbow Fountain‚Äô (–∞–ø—Ä–∏–ª‚Äì–æ–∫—Ç–æ–º–≤—Ä–∏) –ø–æ –º–æ—Å—Ç –ë–∞–Ω–ø–æ. –ö–ª–∞—Å–∏–∫–∞ –∑–∞ –ø–∏–∫–Ω–∏–∫ –∫—Ä–∞–π —Ä. –•–∞–Ω ‚Äì –Ω–∞–π-–¥–æ–±—Ä–æ –≤–µ—á–µ—Ä.",
     official:"https://english.seoul.go.kr/banpo-bridge-moonlight-rainbow-fountain/",
     photoIdeas:["–î—ä–ª–≥–∞ –µ–∫—Å–ø–æ–∑–∏—Ü–∏—è –Ω–∞ —Å—Ç—Ä—É–∏—Ç–µ","–ü–∏–∫–Ω–∏–∫ –Ω–∞ —Ç—Ä–µ–≤–∞—Ç–∞ —Å –º–æ—Å—Ç –Ω–∞ —Ñ–æ–Ω","–°–≤–µ—Ç–ª–∏–Ω–Ω–∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –≤—ä–≤ –≤–æ–¥–∞—Ç–∞"],
     imgIdeas:["Banpo rainbow fountain long exposure","Banpo Hangang picnic night","Banpo bridge reflections"]},
    {title:"Itaewon", lat:37.5345, lng:126.9946, category:"district", top:false,
     img:commons("Itaewon-ro_in_2019.jpg"), wiki:"https://en.wikipedia.org/wiki/Itaewon",
     info_bg:"–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–µ–Ω –∫–≤–∞—Ä—Ç–∞–ª —Å –∫—É—Ö–Ω–∏ –æ—Ç —Ü—è–ª —Å–≤—è—Ç –∏ –¥–∏–Ω–∞–º–∏—á–µ–Ω –Ω–æ—â–µ–Ω –∂–∏–≤–æ—Ç; —Å–ª–µ–¥–≤–∞–π—Ç–µ —É–∫–∞–∑–∞–Ω–∏—è—Ç–∞ –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç –≤ –ø–∏–∫–æ–≤–∏ –ø–µ—Ä–∏–æ–¥–∏.",
     official:"https://english.visitseoul.net/attractions/Itaewon_/1709",
     photoIdeas:["–£–ª–∏—á–Ω–∏ —Ç–∞–±–µ–ª–∏ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –µ–∑–∏—Ü–∏","–ì–ª–µ–¥–∫–∏ –∫—ä–º Namsan","–ë–∞—Ä–æ–≤–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—Ç–∏ –≤–µ—á–µ—Ä"],
     imgIdeas:["Itaewon international signs","Itaewon night street","Itaewon Namsan view"]},
    {title:"Cheonggyecheon Stream", lat:37.5696, lng:126.9780, category:"park", top:false,
     img:commons("Cheonggyecheon_20181125_174338.jpg"), wiki:"https://en.wikipedia.org/wiki/Cheonggyecheon",
     info_bg:"–í—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω 10.9-–∫–º –≥—Ä–∞–¥—Å–∫–∏ –ø–æ—Ç–æ–∫ (–æ—Ç–∫—Ä–∏—Ç –æ—Ç–Ω–æ–≤–æ 2005) —Å–ª–µ–¥ –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –Ω–∞–¥–ª–µ–∑; –Ω–æ—â–Ω–∏ —Å–≤–µ—Ç–ª–∏–Ω–∏, —Ñ–µ—Å—Ç–∏–≤–∞–ª–∏, –≤–æ–¥–æ–ø–∞–¥–∏ –≤ –∑–∞–ø–∞–¥–Ω–∏—è –∫—Ä–∞–π.",
     official:"https://english.seoul.go.kr/policy-information/urban-planning/cheonggyecheon/",
     photoIdeas:["–ù–æ—â–Ω–∏ –º–æ—Å—Ç–æ–≤–µ –∏ —Å–≤–µ—Ç–ª–∏–Ω–∏","–§–µ—Å—Ç–∏–≤–∞–ª –Ω–∞ —Ñ–µ–Ω–µ—Ä–∏—Ç–µ","–°—Ç—ä–ø–∞–ª–∞ –∏ –≤–æ–¥–æ–ø–∞–¥–∏ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ"],
     imgIdeas:["Cheonggyecheon night lights","Cheonggyecheon lanterns","Cheonggyecheon stepping stones"]},
    {title:"Gangnam Style Statue (COEX East Gate)", lat:37.508587, lng:127.040504, category:"view", top:false,
     img:"https://c1.staticflickr.com/5/4546/38337382566_582a930577.jpg",
     wiki:"https://en.wikipedia.org/wiki/Gangnam_Style#Legacy_and_public_impact",
     info_bg:"–ì–∏–≥–∞–Ω—Ç—Å–∫–∞ —Å–∫—É–ª–ø—Ç—É—Ä–∞ (2016) –ø—Ä–µ–¥ –∏–∑—Ç–æ—á–Ω–∏—è –≤—Ö–æ–¥ –Ω–∞ COEX ‚Äì ‚Äò–æ–ø–∞‚Äô –ø–æ–∑–∞—Ç–∞. –ê–∫—Ç–∏–≤–∏—Ä–∞ —Å–µ —Å –º—É–∑–∏–∫–∞/LED –µ—Ñ–µ–∫—Ç–∏ –ø—Ä–∏ —Å—ä–±–∏—Ç–∏—è; –ø–æ–ø—É–ª—è—Ä–Ω–∞ –∑–∞ —Å–Ω–∏–º–∫–∏.",
     official:"https://english.visitseoul.net/attractions/COEX-The-Place_/31496",
     photoIdeas:["–°–∏–º–µ—Ç—Ä–∏—è –ø–æ–¥ ‚Äò—Ä—ä—Ü–µ—Ç–µ‚Äô","–®–∏—Ä–æ–∫–æ—ä–≥—ä–ª–Ω–∏ –∫–∞–¥—Ä–∏ –Ω–æ—â–µ–º","–ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Å COEX –∑–∞–¥ —Å–∫—É–ª–ø—Ç—É—Ä–∞—Ç–∞"],
     imgIdeas:["Gangnam Style Statue Seoul night","Gangnam hands COEX wide angle","Gangnam Style statue photo spots"]}
  ];

  // --- Popup builder ---
  function popupHTML(p){
    const id = slug(p.title);
    const pinterest = 'https://www.pinterest.com/search/pins/?q=' + encodeURIComponent(p.title + ' photography ideas');
    const gis = 'https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(p.title + ' best photo spots');
    const hotelOrigin = HOTEL.lat + ',' + HOTEL.lng;

    function linksFrom(originLatLng){
      return `
        <a href="${gmDirections(originLatLng, p.lat, p.lng, 'transit')}" target="_blank">Transit</a> ‚Ä¢
        <a href="${gmDirections(originLatLng, p.lat, p.lng, 'walking')}" target="_blank">Walk</a> ‚Ä¢
        <a href="${gmDirections(originLatLng, p.lat, p.lng, 'driving')}" target="_blank">Drive</a>`;
    }

    return `
    <div style="min-width:260px; max-width:380px">
      <img class="popup-img" src="${p.img}" alt="${p.title}">
      <h4 style="margin:4px 0 8px;">${p.title}${p.top? ' <span class="label label-warning">Top 10</span>':''}</h4>

      <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#info_${id}" aria-controls="info" role="tab" data-toggle="tab">–ò–Ω—Ñ–æ</a></li>
        <li role="presentation"><a href="#photos_${id}" aria-controls="photos" role="tab" data-toggle="tab">–§–æ—Ç–æ –∏–¥–µ–∏</a></li>
        <li role="presentation"><a href="#nav_${id}" aria-controls="nav" role="tab" data-toggle="tab">–ù–∞–≤–∏–≥–∞—Ü–∏—è</a></li>
      </ul>

      <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="info_${id}">
          <div style="font-size:.95em; line-height:1.45">${p.info_bg}</div>
          <div style="margin-top:8px;">
            <a class="btn btn-xs btn-primary" href="${p.wiki}" target="_blank">–û—â–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (Wikipedia)</a>
            ${p.official? `<a class="btn btn-xs btn-default" href="${p.official}" target="_blank">–û—Ñ–∏—Ü–∏–∞–ª–µ–Ω —Å–∞–π—Ç</a>`:''}
          </div>
        </div>

        <div role="tabpanel" class="tab-pane" id="photos_${id}">
          <b>–ò–¥–µ–∏ –Ω–∞ –º—è—Å—Ç–æ:</b>
          <ul style="padding-left:18px; margin-top:4px;">${(p.photoIdeas||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
          <b>–¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</b>
          <ul style="padding-left:18px; margin-top:4px;">${(p.imgIdeas||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
          <div style="margin-top:8px;">
            <a class="btn btn-xs btn-primary" href="${pinterest}" target="_blank">Pinterest –∏–¥–µ–∏</a>
            <a class="btn btn-xs btn-default" href="${gis}" target="_blank">Google Images —Ç—ä—Ä—Å–µ–Ω–µ</a>
          </div>
        </div>

        <div role="tabpanel" class="tab-pane" id="nav_${id}">
          <div class="gm-actions"><b>–û—Ç —Ö–æ—Ç–µ–ª–∞:</b><br>${linksFrom(hotelOrigin)}</div>
          <div class="gm-actions" style="margin-top:6px;">
            <b>–û—Ç —Ç–µ–∫—É—â–∞—Ç–∞ –ª–æ–∫–∞—Ü–∏—è:</b><br>
            <a href="#" class="dir-cur" data-mode="transit" data-lat="${p.lat}" data-lng="${p.lng}">Transit</a> ‚Ä¢
            <a href="#" class="dir-cur" data-mode="walking" data-lat="${p.lat}" data-lng="${p.lng}">Walk</a> ‚Ä¢
            <a href="#" class="dir-cur" data-mode="driving" data-lat="${p.lat}" data-lng="${p.lng}">Drive</a>
            <div class="cur-hint" style="font-size:.9em; color:#777; margin-top:4px;">(–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ ‚Äû–ù–∞–º–µ—Ä–∏ –º–µ‚Äú, –∞–∫–æ –Ω–µ –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–æ)</div>
          </div>
        </div>
      </div>
    </div>`;
  }

  // --- Markers ---
  const markers = [];
  const POPUP_MAX = Math.min(420, Math.max(280, Math.round(window.innerWidth * 0.9)));

  // Hotel marker
  const hotelMarker = L.marker([HOTEL.lat, HOTEL.lng], {icon:hotelIcon}).addTo(map)
    .bindPopup("<b>"+HOTEL.name+"</b><br>Central Jung District location‚Äîwalkable to Myeongdong and Insadong.", {maxWidth:POPUP_MAX});
  hotelMarker._category = 'hotel';
  hotelMarker._isTop = false;
  markers.push(hotelMarker);

  function addSpot(p){
    const icon = p.top ? goldIcon : blueIcon;
    const m = L.marker([p.lat, p.lng], {icon}).addTo(map).bindPopup(
      popupHTML(p),
      {maxWidth: POPUP_MAX, autoPan: true, autoPanPaddingTopLeft: [80, 100], autoPanPaddingBottomRight: [20, 20]}
    );
    m._category = p.category; m._isTop = !!p.top;
    markers.push(m);
  }
  top10.forEach(addSpot);
  others.forEach(addSpot);

  // Fit all
  function fitAllVisible(){
    const visible = markers.filter(m => map.hasLayer(m));
    if(!visible.length) return;
    map.fitBounds(L.featureGroup(visible).getBounds().pad(0.12));
  }
  fitAllVisible();

  // Filters
  function applyFilters(){
    const activeCats = Array.prototype.slice.call(document.querySelectorAll('.catFilter:checked')).map(x=>x.value);
    const onlyTop = document.getElementById('onlyTop').checked;
    markers.forEach(m=>{
      const catOK = activeCats.indexOf(m._category || 'other') !== -1;
      const topOK = onlyTop ? m._isTop : true;
      const shouldShow = catOK && topOK;
      if(shouldShow && !map.hasLayer(m)) m.addTo(map);
      if(!shouldShow && map.hasLayer(m)) map.removeLayer(m);
    });
  }
  $('.catFilter').on('change', function(){ applyFilters(); });
  $('#onlyTop').on('change', function(){ applyFilters(); });

  $('#btnReset').on('click', function(){
    $('.catFilter').prop('checked', true);
    $('#onlyTop').prop('checked', false);
    applyFilters(); fitAllVisible();
  });
  document.getElementById('btnFit').addEventListener('click', fitAllVisible);

  // Collapse / expand
  function setCollapsed(coll){
    const panel = document.getElementById('sidePanel');
    if(coll){
      panel.classList.add('collapsed');
      $('#collapseIcon').removeClass('glyphicon-menu-up').addClass('glyphicon-menu-down');
    }else{
      panel.classList.remove('collapsed');
      $('#collapseIcon').removeClass('glyphicon-menu-down').addClass('glyphicon-menu-up');
      panel.style.top = '10px';
    }
  }
  // Start collapsed on small screens
  if(window.matchMedia && window.matchMedia('(max-width:560px)').matches){ setCollapsed(true); }
  $('#panelHeader').on('click', function(){
    const isCollapsed = document.getElementById('sidePanel').classList.contains('collapsed');
    setCollapsed(!isCollapsed);
  });

  // Recompute popup max width on rotate/resize for future popups
  window.addEventListener('resize', function(){
    // You can close & reopen popups to apply new width if needed.
  });

  // Geolocation + dynamic nav links
  function ensureCurrentLocation(cb){
    if(currentLoc){ cb(currentLoc); return; }
    if(!navigator.geolocation){ alert('Geolocation –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –æ—Ç —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä.'); return; }
    navigator.geolocation.getCurrentPosition(function(pos){
      currentLoc = {lat:pos.coords.latitude, lng:pos.coords.longitude};
      if(currentDot) map.removeLayer(currentDot);
      currentDot = L.circleMarker(currentLoc, {radius:8, color:'#111', fillColor:'#00e', fillOpacity:.6}).addTo(map);
      currentDot.bindPopup('<b>–í–∞—à–∞—Ç–∞ –ª–æ–∫–∞—Ü–∏—è</b>');
      cb(currentLoc);
    }, function(err){ alert('–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Å–∏—á–∞–Ω–µ –Ω–∞ –ª–æ–∫–∞—Ü–∏—è—Ç–∞: ' + err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
  }

  $('#btnLocate').on('click', function(){
    ensureCurrentLocation(function(loc){
      map.setView([loc.lat, loc.lng], Math.max(map.getZoom(), 14));
      if(currentDot) currentDot.openPopup();
    });
  });

  map.on('popupopen', function(e){
    const container = e.popup.getElement();
    if(!container) return;
    $(container).find('.dir-cur').off('click').on('click', function(ev){
      ev.preventDefault();
      const mode = this.getAttribute('data-mode');
      const lat = this.getAttribute('data-lat');
      const lng = this.getAttribute('data-lng');
      ensureCurrentLocation(function(loc){
        const href = gmDirections(loc.lat+','+loc.lng, lat, lng, mode);
        window.open(href, '_blank');
      });
    });
  });
</script>
</body>
</html>
