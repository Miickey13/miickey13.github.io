<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¢–æ–∫–∏–æ ‚Äì –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∫–∞—Ä—Ç–∞ (—Ç–æ–ø 10 —Å—ä—Å –∑–ª–∞—Ç–Ω–∏ –ø–∏–Ω–æ–≤–µ + –ø–æ–¥—Ä–æ–±–Ω–∏ —Ä–µ–∑—é–º–µ—Ç–∞)</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- jQuery + Bootstrap (to match Seoul popup tabs/look) -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

  <!-- AwesomeMarkers for Seoul-style pins -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    /* Keep popups above the side panel */
    .leaflet-pane.leaflet-popup-pane { z-index: 3000 !important; }
    .leaflet-popup-content{
      margin:8px 12px;
      font-size:15.5px;         /* ‚¨ÖÔ∏è bigger popup font */
      line-height:1.55;
    }
    .popup-img{ width:100%; height:auto; border-radius:8px; margin-bottom:6px; object-fit:cover; }

    /* Seoul-style side panel (collapsible) */
    #sidePanel{
      position:fixed; left:10px; top:10px; z-index:1200;
      width:300px; max-width:90vw; background:#fff; border-radius:12px;
      border:1px solid #e8e8e8; box-shadow:0 6px 24px rgba(0,0,0,.18);
      overflow:hidden; transition: top .18s ease, width .18s ease, border-radius .18s ease;
      touch-action: manipulation; font: 14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    #panelHeader{
      background:#111; color:#fff; padding:10px 12px; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      -webkit-tap-highlight-color: transparent; user-select:none; -webkit-user-select:none;
    }
    #panelHeader .title{ display:flex; align-items:center; gap:8px; }
    #panelHeader h4{ margin:0; font-size:15px; font-weight:600; }
    #panelHeader .mini{ display:none; }
    #panelBody{ padding:10px 12px; }
    #panelFooter{ padding:10px 12px; border-top:1px solid #eee; display:flex; gap:6px; flex-wrap:wrap; }
    #panelFooter button{ border:0; border-radius:8px; padding:6px 10px; background:#111; color:#fff; }
    #panelFooter button.alt{ background:#666; }
    #panelFooter button.ghost{ background:#fff; color:#111; border:1px solid #ddd; }

    .cat-list{ list-style:none; padding:0; margin:0; }
    .cat-list li{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .cat-list .emoji{ width:20px; text-align:center; }
    .legend-box{ margin-top:8px; font-size:12px; color:#444; }
    .legend-dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin:0 4px; vertical-align:middle; }
    .legend-gold{ background:linear-gradient(180deg,#ffdc73,#e2a500); border:1px solid #c89200; }
    .legend-blue{ background:#3388ff; border:1px solid #1d5fcc; }
    .legend-green{ background:#43a047; border:1px solid #2e7d32; }

    /* Collapsed (like Seoul) */
    #sidePanel.collapsed{
      width:52px; border-radius:12px;
      top:calc(74px + env(safe-area-inset-top));
    }
    #sidePanel.collapsed #panelBody,
    #sidePanel.collapsed #panelFooter,
    #sidePanel.collapsed #panelHeader .title { display:none !important; }
    #sidePanel.collapsed #panelHeader .mini { display:inline-block; }

    /* Toast & modal (unchanged) */
    .toast {
      position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,.86); color: #fff; padding: 8px 12px; border-radius: 8px;
      font: 13px/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; z-index: 3200;
      display: none;
    }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; z-index: 3300; align-items: center; justify-content: center; padding: 20px; }
    .modal { max-width: 820px; width: 100%; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); font: 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; overflow: hidden; }
    .modal header { padding: 14px 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal header h3 { margin: 0; font-size: 18px; }
    .close { background: transparent; border: none; font-size: 22px; cursor: pointer; }
    .tabs { display: flex; gap: 8px; padding: 8px 12px; border-bottom: 1px solid #f1f1f1; }
    .tab-btn { background: #f3f4f6; border: none; padding: 6px 10px; border-radius: 999px; cursor: pointer; font-size: 13px; }
    .tab-btn.active { background: #111827; color: #fff; }
    .modal .content { padding: 14px 16px; max-height: 70vh; overflow: auto; }
    .modal .content img { width: 100%; height: auto; border-radius: 8px; margin: 6px 0 12px; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin: 0 0 10px; }
    .chip { background: #f3f4f6; color: #111827; font-size: 12px; padding: 4px 8px; border-radius: 999px; }
    .links a { color: #2563eb; text-decoration: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Seoul-style collapsible filter panel -->
  <div id="sidePanel">
    <div id="panelHeader" title="–°–∫—Ä–∏–π/–ø–æ–∫–∞–∂–∏ —Ñ–∏–ª—Ç—Ä–∏—Ç–µ" role="button" aria-expanded="true">
      <div class="title">
        <span class="glyphicon glyphicon-filter" aria-hidden="true"></span>
        <h4>–§–∏–ª—Ç—ä—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
      </div>
      <span class="mini glyphicon glyphicon-filter" aria-hidden="true" title="–§–∏–ª—Ç—Ä–∏"></span>
      <span class="glyphicon glyphicon-menu-up" id="collapseIcon" aria-hidden="true" title="–°–∫—Ä–∏–π"></span>
    </div>

    <div id="panelBody">
      <ul class="cat-list">
        <li><span class="emoji">üõï</span><label><input type="checkbox" class="catFilter" value="temple" checked> –•—Ä–∞–º–æ–≤–µ/–°–≤–µ—Ç–∏–ª–∏—â–∞</label></li>
        <li><span class="emoji">üóº</span><label><input type="checkbox" class="catFilter" value="view" checked> –õ–∞–Ω–¥–º–∞—Ä–∫–∏/–û–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏–∏</label></li>
        <li><span class="emoji">üå≥</span><label><input type="checkbox" class="catFilter" value="park" checked> –ì—Ä–∞–¥–∏–Ω–∏/–ü–∞—Ä–∫–æ–≤–µ</label></li>
        <li><span class="emoji">üêü</span><label><input type="checkbox" class="catFilter" value="market" checked> –ü–∞–∑–∞—Ä–∏/–•—Ä–∞–Ω–∞</label></li>
        <li><span class="emoji">üèôÔ∏è</span><label><input type="checkbox" class="catFilter" value="district" checked> –ö–≤–∞—Ä—Ç–∞–ª–∏</label></li>
        <li><span class="emoji">üñºÔ∏è</span><label><input type="checkbox" class="catFilter" value="museum" checked> –ú—É–∑–µ–∏/–ò–∑–∫—É—Å—Ç–≤–æ</label></li>
        <li><span class="emoji">üèØ</span><label><input type="checkbox" class="catFilter" value="palace" checked> –î–≤–æ—Ä–µ—Ü/–ù–∞—Å–ª–µ–¥—Å—Ç–≤–æ</label></li>
        <li><span class="emoji">üè®</span><label><input type="checkbox" class="catFilter" value="hotel" checked> –•–æ—Ç–µ–ª–∏</label></li>
        <li><span class="emoji">‚ûï</span><label><input type="checkbox" class="catFilter" value="other" checked> –î—Ä—É–≥–æ</label></li>
      </ul>

      <div style="margin-top:10px;">
        <label><input type="checkbox" id="onlyTop"> –°–∞–º–æ –¢–æ–ø 10</label>
      </div>

      <div class="legend-box">
        <p><b>‚Ä¢</b> <span class="legend-dot legend-gold"></span> –ó–ª–∞—Ç–µ–Ω –ø–∏–Ω = –¢–æ–ø 10 –¢–æ–∫–∏–æ</p>
        <p><b>‚Ä¢</b> <span class="legend-dot legend-blue"></span> –°–∏–Ω –ø–∏–Ω = –¥—Ä—É–≥–∏ –º–µ—Å—Ç–∞</p>
        <p><b>‚Ä¢</b> <span class="legend-dot legend-green"></span> –ó–µ–ª–µ–Ω –ø–∏–Ω = —Ö–æ—Ç–µ–ª</p>
      </div>
    </div>

    <div id="panelFooter">
      <button id="btnLocate" title="–ü–æ–∫–∞–∂–∏ —Ç–µ–∫—É—â–∞—Ç–∞ –º–∏ –ª–æ–∫–∞—Ü–∏—è">–ù–∞–º–µ—Ä–∏ –º–µ</button>
      <button class="alt" id="btnFit" title="–ü–æ–±–µ—Ä–∏ –≤—Å–∏—á–∫–∏ –º–∞—Ä–∫–µ—Ä–∏">–ü–æ–±–µ—Ä–∏ –≤—Å–∏—á–∫–∏</button>
      <button class="ghost" id="btnReset" title="–ù—É–ª–∏—Ä–∞–π —Ñ–∏–ª—Ç—Ä–∏—Ç–µ">–ù—É–ª–∏—Ä–∞–π</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Modal (unchanged; still available) -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3 id="modalTitle">–ó–∞–≥–ª–∞–≤–∏–µ</h3>
        <button class="close" id="modalClose" aria-label="–ó–∞—Ç–≤–æ—Ä–∏">√ó</button>
      </header>
      <div class="tabs">
        <button class="tab-btn active" data-tab="info">‚ÑπÔ∏è –ò–Ω—Ñ–æ</button>
        <button class="tab-btn" data-tab="photos">üì∏ –§–æ—Ç–æ –∏–¥–µ–∏</button>
      </div>
      <div class="content" id="modalContent"></div>
    </div>
  </div>

  <script>
    function showToast(msg, ms = 2200) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(el._t);
      el._t = setTimeout(() => el.style.display = 'none', ms);
    }
    const wmf = (file) => `https://commons.wikimedia.org/wiki/Special:FilePath/${file}?width=640`;
    const HOTEL_ORIGIN = { lat: 35.6959, lng: 139.7062 }; // Petit Bali Higashi Shinjuku
    const pinterestSearch = (name) => 'https://www.pinterest.com/search/pins/?q=' + encodeURIComponent(name + ' photography ideas');
    const gimageSearch = (name) => 'https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(name + ' best photo spots');
    const slug = (s) => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');

    // ---------- DATA ----------
    const spots = [
      /* Top 10 (gold pins) */
      { name: "Sens≈ç-ji (Asakusa)", coords: [35.7148,139.7967], top: true, categories: ["Temple/Shrine"],
        img: wmf("Sensoji_Temple.JPG"),
        link: "https://en.wikipedia.org/wiki/Sens%C5%8D-ji",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ",
        info: "–ù–∞–π-—Å—Ç–∞—Ä–∏—è—Ç –±—É–¥–∏—Å—Ç–∫–∏ —Ö—Ä–∞–º –≤ –¢–æ–∫–∏–æ (–æ—Å–Ω–æ–≤–∞–Ω 645 –≥.) —Å—ä—Å —Å–≤–µ—â–µ–Ω–∞—Ç–∞ —Å—Ç–∞—Ç—É—è –Ω–∞ –ö–∞–Ω–Ω–æ–Ω, –æ—Ç–∫—Ä–∏—Ç–∞ —Å–ø–æ—Ä–µ–¥ –ª–µ–≥–µ–Ω–¥–∞—Ç–∞ –æ—Ç –¥–≤–∞–º–∞ —Ä–∏–±–∞—Ä–∏ –ø—Ä–µ–∑ 628 –≥. –í—Ö–æ–¥—ä—Ç –º–∏–Ω–∞–≤–∞ –ø—Ä–µ–∑ –ö–∞–º–∏–Ω–∞—Ä–∏–º–æ–Ω –∏ –ù–∞–∫–∞–º–∏—Å–µ‚Äì–¥–æ—Ä—ù –¥–æ –•–æ–∑–æ–º–æ–Ω –∏ –ø–µ—Ç–µ—Ç–∞–∂–Ω–∞—Ç–∞ –ø–∞–≥–æ–¥–∞."
      },
      { name: "Shibuya Crossing", coords: [35.6595,139.7005], top: true, categories: ["District/Neighborhood","Landmark/Observation"],
        img: wmf("Tokyo_Shibuya_Scramble_Crossing_2018-10-09.jpg"),
        link: "https://en.wikipedia.org/wiki/Shibuya_Crossing",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ",
        info: "–ï–º–±–ª–µ–º–∞—Ç–∏—á–Ω–æ—Ç–æ ‚Äû—Å–∫—Ä–∞–º–±—ä–ª‚Äú –ø—Ä–µ—Å–∏—á–∞–Ω–µ –ø—Ä–µ–¥ –∏–∑—Ö–æ–¥ –•–∞—á–∏–∫–æ –Ω–∞ –≥–∞—Ä–∞ –®–∏–±—É—è; –æ–≥—Ä–æ–º–Ω–∏ —Ç—ä–ª–ø–∏ –∏ –Ω–µ–æ–Ω–æ–≤–∏ –µ–∫—Ä–∞–Ω–∏."
      },
      { name: "Meiji Shrine (Meiji Jing≈´)", coords: [35.6764,139.6993], top: true, categories: ["Temple/Shrine","Garden/Park"],
        img: wmf("Meiji_Shrine_-_Main_building.jpg"),
        link: "https://en.wikipedia.org/wiki/Meiji_Shrine",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ (–¥–∞—Ä–µ–Ω–∏–µ –ø–æ –∂–µ–ª–∞–Ω–∏–µ)",
        info: "–®–∏–Ω—Ç–æ —Å–≤–µ—Ç–∏–ª–∏—â–µ –≤ –≥–æ—Ä–∞ —Å ~120 000 –¥—ä—Ä–≤–µ—Ç–∞; —á–µ—Å—Ç–æ –º–æ–≥–∞—Ç –¥–∞ —Å–µ –≤–∏–¥—è—Ç —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ —Å–≤–∞—Ç–±–∏."
      },
      { name: "Tokyo Skytree", coords: [35.7101,139.8107], top: true, categories: ["Landmark/Observation"],
        img: wmf("Tokyo_Skytree_Japan.jpg"),
        link: "https://en.wikipedia.org/wiki/Tokyo_Skytree",
        fee: "–ü–ª–∞—Ç–µ–Ω–æ (–≤–∞—Ä–∏—Ä–∞ ‚Äì –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∏—è —Å–∞–π—Ç)",
        info: "–ù–∞–π-–≤–∏—Å–æ–∫–∞—Ç–∞ –∫—É–ª–∞ –≤ —Å–≤–µ—Ç–∞ (634 –º) —Å –¥–≤–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–Ω–∏ –ø–ª–æ—â–∞–¥–∫–∏ –∏ –ø–∞–Ω–æ—Ä–∞–º–∏ –∫—ä–º –§—É–¥–∂–∏ –ø—Ä–∏ —è—Å–Ω–æ –≤—Ä–µ–º–µ."
      },
      { name: "Tokyo Tower", coords: [35.6586,139.7456], top: true, categories: ["Landmark/Observation"],
        img: wmf("TOKYO_TOWER.jpg"),
        link: "https://en.wikipedia.org/wiki/Tokyo_Tower",
        fee: "–ü–ª–∞—Ç–µ–Ω–æ (–≤–∞—Ä–∏—Ä–∞ ‚Äì –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∏—è —Å–∞–π—Ç)",
        info: "–ö–ª–∞—Å–∏—á–µ—Å–∫–∏—è—Ç —Å–∏–º–≤–æ–ª (1958, 333 –º) —Å –¥–≤–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–Ω–∏—Ü–∏ –∏ –≤–µ—á–µ—Ä–Ω–∏ –æ—Å–≤–µ—Ç–ª–µ–Ω–∏—è."
      },
      { name: "Shinjuku Gyoen National Garden", coords: [35.6853,139.7094], top: true, categories: ["Garden/Park"],
        img: wmf("Shinjuku_Gyoen_National_Garden_-_DSC05149.JPG"),
        link: "https://en.wikipedia.org/wiki/Shinjuku_Gyo-en",
        fee: "–ü–ª–∞—Ç–µ–Ω–æ (–ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –∞–∫—Ç—É–∞–ª–Ω–∏—Ç–µ —Ü–µ–Ω–∏)",
        info: "58 —Ö–∞ —è–ø–æ–Ω—Å–∫–∞, —Ñ—Ä–µ–Ω—Å–∫–∞ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∞ –≥—Ä–∞–¥–∏–Ω–∞; ~1500 —á–µ—Ä–µ—à–∏ –∏ –≤–ø–µ—á–∞—Ç–ª—è–≤–∞—â–∞ –µ—Å–µ–Ω."
      },
      { name: "Tsukiji Outer Market", coords: [35.6655,139.7708], top: true, categories: ["Market/Food"],
        img: wmf("Tsukiji_Outer_Market_-01.jpg"),
        link: "https://en.wikipedia.org/wiki/Tsukiji_fish_market",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ (–∫–æ–Ω—Å—É–º–∞—Ü–∏–∏—Ç–µ —Å–µ –∑–∞–ø–ª–∞—â–∞—Ç)",
        info: "–ñ–∏–≤ –ª–∞–±–∏—Ä–∏–Ω—Ç –æ—Ç —â–∞–Ω–¥–æ–≤–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—Ç–∏ ‚Äì —Å—É—à–∏ –Ω–∞ –∑–∞–∫—É—Å–∫–∞, —Ç–∞–º–∞–≥–æ—è–∫–∏ –∏ –º–æ—Ä—Å–∫–∏ –¥–∞—Ä–æ–≤–µ."
      },
      { name: "Akihabara (Electric Town)", coords: [35.6984,139.7730], top: true, categories: ["District/Neighborhood"],
        img: wmf("Akihabara_Electric_Town_9999_281.jpg"),
        link: "https://en.wikipedia.org/wiki/Akihabara",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ",
        info: "–ï–ø–∏—Ü–µ–Ω—Ç—ä—Ä –Ω–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞, –∏–≥—Ä–∏ –∏ –æ—Ç–∞–∫—É –∫—É–ª—Ç—É—Ä–∞ —Å –Ω–µ–æ–Ω–æ–≤–∏ —Ñ–∞—Å–∞–¥–∏ –∏ –∞—Ä–∫–∞–¥–∏."
      },
      { name: "teamLab Planets TOKYO (Toyosu)", coords: [35.6491,139.7895], top: true, categories: ["Museum/Art"],
        img: wmf("At_teamLab_Planets_(48277793276).jpg"),
        link: "https://en.wikipedia.org/wiki/TeamLab_Planets_TOKYO_DMM.com",
        fee: "–ü–ª–∞—Ç–µ–Ω–æ (–æ–Ω–ª–∞–π–Ω –±–∏–ª–µ—Ç–∏/—Å–ª–æ—Ç–æ–≤–µ)",
        info: "–ò–º—ä—Ä—Å–∏–≤–Ω–∏ —Å–≤–µ—Ç–ª–∏–Ω–Ω–∏ –∏ –≤–æ–¥–Ω–∏ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏–∏ ‚Äì –µ–¥–Ω–æ –æ—Ç –Ω–∞–π-—Ñ–æ—Ç–æ–≥–µ–Ω–∏—á–Ω–∏—Ç–µ –º–µ—Å—Ç–∞ –≤ –¢–æ–∫–∏–æ."
      },
      { name: "Tokyo Imperial Palace & East Gardens", coords: [35.6825,139.7521], top: true, categories: ["Palace/Heritage","Garden/Park"],
        img: wmf("Imperial_Palace_Tokyo_Nijubashi_Bridge.JPG"),
        link: "https://en.wikipedia.org/wiki/Tokyo_Imperial_Palace",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ (–ò–∑—Ç–æ—á–Ω–∏ –≥—Ä–∞–¥–∏–Ω–∏; –¥–≤–æ—Ä–µ—Ü—ä—Ç –µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—ä–ø)",
        info: "–î–≤–æ—Ä–µ—Ü—ä—Ç –≤—ä—Ä—Ö—É –º—è—Å—Ç–æ—Ç–æ –Ω–∞ –∑–∞–º—ä–∫–∞ –ï–¥–æ; –ø–æ–ø—É–ª—è—Ä–Ω–∏ —Å–∞ –≥–ª–µ–¥–∫–∏—Ç–µ –∫—ä–º –º–æ—Å—Ç–æ–≤–µ—Ç–µ –ù–∏–¥–∂—É–±–∞—à–∏."
      },

      /* Others (blue) */
      { name: "Shibuya Sky (Shibuya Scramble Square)", coords: [35.6581,139.7017], categories: ["Landmark/Observation"],
        img: wmf("Shibuya_Scramble_Square_-_SHIBUYA_SKY.jpg"),
        link: "https://commons.wikimedia.org/wiki/File:Shibuya_Scramble_Square_-_SHIBUYA_SKY.jpg",
        fee: "–ü–ª–∞—Ç–µ–Ω–æ (—Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –ø—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–∞)",
        info: "–û—Ç–∫—Ä–∏—Ç–∞ –ø–ª–æ—â–∞–¥–∫–∞ 360¬∞ –Ω–∞–¥ –®–∏–±—É—è ‚Äì —Ä–µ–∑–µ—Ä–≤–∏—Ä–∞–π—Ç–µ –∑–∞ –∑–∞–ª–µ–∑."
      },
      { name: "Miyashita Park", coords: [35.6612,139.6995], categories: ["District/Neighborhood","Garden/Park"],
        img: wmf("Miyashita_Park_Shibuya_Tokyo.jpg"),
        link: "https://commons.wikimedia.org/wiki/File:Miyashita_Park_Shibuya_Tokyo.jpg",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ",
        info: "–ú–æ–¥–µ—Ä–µ–Ω —Ç—ä—Ä–≥–æ–≤—Å–∫–∏ –∫–æ–º–ø–ª–µ–∫—Å —Å –ø–æ–∫—Ä–∏–≤–µ–Ω –ø–∞—Ä–∫ (2020) –º–µ–∂–¥—É –®–∏–±—É—è –∏ –•–∞—Ä–∞–¥–∂—É–∫—É."
      },
      { name: "Takeshita Street (Harajuku)", coords: [35.6717,139.7030], categories: ["District/Neighborhood","Market/Food"],
        img: wmf("Takeshita_Street_(53131946200).jpg"),
        link: "https://commons.wikimedia.org/wiki/File:Takeshita_Street_(53131946200).jpg",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ",
        info: "–ú–ª–∞–¥–µ–∂–∫–∞ –º–æ–¥–∞, –¥–µ—Å–µ—Ä—Ç–∏ –∏ —Ç–µ–º–∞—Ç–∏—á–Ω–∏ –∫–∞—Ñ–µ–Ω–µ—Ç–∞."
      },
      { name: "Omotesand≈ç", coords: [35.6654,139.7124], categories: ["District/Neighborhood"],
        img: wmf("Omotesando_2007_a.JPG"),
        link: "https://commons.wikimedia.org/wiki/File:Omotesando_2007_a.JPG",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ",
        info: "–ï–ª–µ–≥–∞–Ω—Ç–µ–Ω –±—É–ª–µ–≤–∞—Ä–¥ —Å —Ñ–ª–∞–≥–º–∞–Ω-–º–∞–≥–∞–∑–∏–Ω–∏ –∏ –∏–∑–≤–µ—Å—Ç–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞."
      },
      { name: "Kabukich≈ç (Shinjuku)", coords: [35.6940,139.7036], categories: ["District/Neighborhood"],
        img: wmf("Gate_of_Kabuki-cho_Ichiban-gai.jpg"),
        link: "https://commons.wikimedia.org/wiki/File:Gate_of_Kabuki-cho_Ichiban-gai.jpg",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ",
        info: "–ù–µ–æ–Ω–æ–≤ —Ä–∞–π–æ–Ω –∑–∞ –Ω–æ—â–µ–Ω –∂–∏–≤–æ—Ç; –≤–Ω–∏–º–∞–≤–∞–π—Ç–µ —Å –∞–≥—Ä–µ—Å–∏–≤–Ω–∏ –ø—Ä–æ–º–æ—É—Ç—ä—Ä–∏."
      },
      { name: "Omoide Yokocho", coords: [35.6938,139.7004], categories: ["Market/Food","District/Neighborhood"],
        img: wmf("Omoide_Yokocho,_Shinjuku_(44192124461).jpg"),
        link: "https://commons.wikimedia.org/wiki/File:Omoide_Yokocho,_Shinjuku_(44192124461).jpg",
        fee: "–ë–µ–∑–ø–ª–∞—Ç–Ω–æ (–∫–æ–Ω—Å—É–º–∞—Ü–∏–∏—Ç–µ —Å–µ –∑–∞–ø–ª–∞—â–∞—Ç)",
        info: "–¢–µ—Å–Ω–∏ —É–ª–∏—á–∫–∏ —Å –º–∏–Ω–∏ –∏–∑–∞–∫–∞—è –∏ –≤—ä–≥–ª–µ–Ω–æ–≤–∞ —Å–∫–∞—Ä–∞; –Ω–∞–π-–æ–∂–∏–≤–µ–Ω–æ —Å–ª–µ–¥ 17:00."
      },
      { name: "Golden Gai", coords: [35.6947,139.7041], categories: ["District/Neighborhood"],
        img: wmf("Shinjuku_Golden_Gai_(2).jpg"),
        link: "https://commons.wikimedia.org/wiki/File:Shinjuku_Golden_Gai_(2).jpg",
        fee: "–°–≤–æ–±–æ–¥–µ–Ω –¥–æ—Å—Ç—ä–ø; –º–Ω–æ–≥–æ –±–∞—Ä–æ–≤–µ –∏–º–∞—Ç —Ç–∞–∫—Å–∞ ‚Äû—á–∞—Ä–¥–∂‚Äú",
        info: "~200 –º–∏–∫—Ä–æ–±–∞—Ä–∞ –≤ 6 –∞–ª–µ–∏; –Ω–∞–π-–¥–æ–±—Ä–µ —Å–ª–µ–¥ 21:00."
      },
      { name: "Fuunji (Tsukemen)", coords: [35.6909,139.6983], categories: ["Market/Food","Other"],
        img: wmf("Chicken_Gyokai_Tsukemen_%40_Fuunji_%40_Shinjuku_(11324273213).jpg"),
        link: "https://commons.wikimedia.org/wiki/File:Chicken_Gyokai_Tsukemen_%40_Fuunji_%40_Shinjuku_(11324273213).jpg",
        fee: "–ù—è–º–∞ –≤—Ö–æ–¥; –∑–∞–ø–ª–∞—â–∞–Ω–µ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞",
        info: "–ö—É–ª—Ç–æ–≤ —Ü—É–∫–µ–º–µ–Ω; –æ—á–∞–∫–≤–∞–π—Ç–µ –æ–ø–∞—à–∫–∞ 30‚Äì45 –º–∏–Ω."
      },

      /* Hotel */
      { name: "Hotel Petit Bali Higashi Shinjuku", coords: [35.6959,139.7062], categories: ["Hotel"],
        img: wmf("Higashi-shinjuku_Sta._Exit-B2.JPG"),
        link: "https://commons.wikimedia.org/wiki/File:Higashi-shinjuku_Sta._Exit-B2.JPG",
        fee: "‚Äî",
        info: "–ë—É—Ç–∏–∫–æ–≤ —Ö–æ—Ç–µ–ª –¥–æ —Å—Ç. Higashi-Shinjuku ‚Äì —É–¥–æ–±–µ–Ω –∑–∞ –ö–∞–±—É–∫–∏—á–æ/–ì–æ–ª–¥–µ–Ω –ì–∞–π."
      }
    ];

    // ---------- MAP ----------
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    // ---- Seoul-style icons ----
    const goldIcon  = L.AwesomeMarkers.icon({icon:'star',      prefix:'glyphicon', markerColor:'orange', iconColor:'#fff'});
    const blueIcon  = L.AwesomeMarkers.icon({icon:'info-sign', prefix:'glyphicon', markerColor:'blue',   iconColor:'#fff'});
    const hotelIcon = L.AwesomeMarkers.icon({icon:'home',      prefix:'glyphicon', markerColor:'green',  iconColor:'#fff'});

    // Normalize categories to Seoul keys
    function normCat(list){
      const mapCat = (c) =>
        c==="Temple/Shrine" ? "temple" :
        c==="Landmark/Observation" ? "view" :
        c==="Garden/Park" ? "park" :
        c==="Market/Food" ? "market" :
        c==="District/Neighborhood" ? "district" :
        c==="Museum/Art" ? "museum" :
        c==="Palace/Heritage" ? "palace" :
        c==="Hotel" ? "hotel" : "other";
      if (!Array.isArray(list) || !list.length) return "other";
      const mapped = list.map(mapCat);
      return mapped.includes("hotel") ? "hotel" : mapped[0] || "other";
    }

    // Google Maps directions
    function gmapsUrl(originLatLng, destLatLng, mode = 'walking') {
      const origin = `${originLatLng.lat},${originLatLng.lng}`;
      const dest = `${destLatLng.lat},${destLatLng.lng}`;
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=${encodeURIComponent(mode)}`;
    }

    // --- Seoul-style popup builder with tabs (Info / Photo / Nav) ---
    function popupHTML(s){
      const id = slug(s.name);
      const dest = { lat: s.coords[0], lng: s.coords[1] };
      const pPins = s.pinterest || [];
      const gImgs = s.gimages  || [];
      const pinList = pPins.map(u=>`<li><a href="${u}" target="_blank" rel="noopener">${u}</a></li>`).join('') || '<li>–ù—è–º–∞ –ø–æ–¥–±—Ä–∞–Ω–∏ –ª–∏–Ω–∫–æ–≤–µ.</li>';
      const gList   = gImgs.map(u=>`<li><a href="${u}" target="_blank" rel="noopener">${u}</a></li>`).join('') || '';

      const fromHotelTransit = gmapsUrl(HOTEL_ORIGIN, dest, 'transit');
      const fromHotelWalk    = gmapsUrl(HOTEL_ORIGIN, dest, 'walking');
      const fromHotelDrive   = gmapsUrl(HOTEL_ORIGIN, dest, 'driving');

      return `
      <div style="min-width:260px; max-width:380px">
        <img class="popup-img" src="${s.img}" alt="${s.name}">
        <h4 style="margin:4px 0 8px;">${s.name}${s.top? ' <span class="label label-warning">Top 10</span>':''}</h4>

        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="active"><a href="#info_${id}" aria-controls="info" role="tab" data-toggle="tab">–ò–Ω—Ñ–æ</a></li>
          <li role="presentation"><a href="#photos_${id}" aria-controls="photos" role="tab" data-toggle="tab">–§–æ—Ç–æ –∏–¥–µ–∏</a></li>
          <li role="presentation"><a href="#nav_${id}" aria-controls="nav" role="tab" data-toggle="tab">–ù–∞–≤–∏–≥–∞—Ü–∏—è</a></li>
        </ul>

        <div class="tab-content">
          <div role="tabpanel" class="tab-pane active" id="info_${id}">
            <div>${s.info || ''}</div>
            <div style="margin-top:6px;"><b>–¢–∞–∫—Å–∞ –≤—Ö–æ–¥:</b> ${s.fee || '‚Äî'}</div>
            <div style="margin-top:8px;">
              ${s.link ? `<a class="btn btn-xs btn-primary" href="${s.link}" target="_blank">–û—â–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (Wikipedia)</a>` : ''}
            </div>
          </div>

          <div role="tabpanel" class="tab-pane" id="photos_${id}">
            <b>–ü–æ–¥–±—Ä–∞–Ω–∏ –ª–∏–Ω–∫–æ–≤–µ (Pinterest):</b>
            <ul style="padding-left:18px; margin-top:4px;">${pinList}</ul>
            ${gList ? `<b>Google Images –∑–∞—è–≤–∫–∏:</b><ul style="padding-left:18px; margin-top:4px;">${gList}</ul>` : ''}
            <div style="margin-top:8px;">
              <a class="btn btn-xs btn-primary" href="${pinterestSearch(s.name)}" target="_blank">Pinterest —Ç—ä—Ä—Å–µ–Ω–µ</a>
              <a class="btn btn-xs btn-default" href="${gimageSearch(s.name)}" target="_blank">Google Images</a>
            </div>
          </div>

          <div role="tabpanel" class="tab-pane" id="nav_${id}">
            <div class="gm-actions"><b>–û—Ç —Ö–æ—Ç–µ–ª–∞:</b><br>
              <a href="${fromHotelTransit}" target="_blank">Transit</a> ‚Ä¢
              <a href="${fromHotelWalk}" target="_blank">Walk</a> ‚Ä¢
              <a href="${fromHotelDrive}" target="_blank">Drive</a>
            </div>
            <div class="gm-actions" style="margin-top:6px;">
              <b>–û—Ç —Ç–µ–∫—É—â–∞—Ç–∞ –ª–æ–∫–∞—Ü–∏—è:</b><br>
              <a href="#" class="dir-cur" data-mode="transit" data-lat="${dest.lat}" data-lng="${dest.lng}">Transit</a> ‚Ä¢
              <a href="#" class="dir-cur" data-mode="walking" data-lat="${dest.lat}" data-lng="${dest.lng}">Walk</a> ‚Ä¢
              <a href="#" class="dir-cur" data-mode="driving" data-lat="${dest.lat}" data-lng="${dest.lng}">Drive</a>
              <div class="cur-hint" style="font-size:.9em; color:#777; margin-top:4px;">(–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ ‚Äû–ù–∞–º–µ—Ä–∏ –º–µ‚Äú, –∞–∫–æ –Ω–µ –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–æ)</div>
            </div>
          </div>
        </div>
      </div>`;
    }

    // ---- Build markers with Seoul-style pins + filtering ----
    const markers = [];
    const boundsAll = L.latLngBounds();

    spots.forEach(s => {
      const cat = normCat(s.categories||[]);
      const isHotel = cat === 'hotel';
      const icon = isHotel ? hotelIcon : (s.top ? goldIcon : blueIcon);
      const m = L.marker(s.coords, { icon, title: s.name }).addTo(map).bindPopup(popupHTML(s), {maxWidth: 420});
      m._category = cat; m._isTop = !!s.top;
      markers.push(m);
      boundsAll.extend(s.coords);
    });
    map.fitBounds(boundsAll.pad(0.1));

    function applyFilters(){
      const activeCats = Array.from(document.querySelectorAll('.catFilter:checked')).map(x=>x.value);
      const onlyTop = document.getElementById('onlyTop').checked;
      markers.forEach(m=>{
        const catOK = activeCats.indexOf(m._category||'other') !== -1;
        const topOK = onlyTop ? m._isTop : true;
        const show = catOK && topOK;
        if(show && !map.hasLayer(m)) m.addTo(map);
        if(!show && map.hasLayer(m)) map.removeLayer(m);
      });
    }
    document.querySelectorAll('.catFilter').forEach(el=>el.addEventListener('change', applyFilters));
    document.getElementById('onlyTop').addEventListener('change', applyFilters);

    function fitAllVisible(){
      const visible = markers.filter(m => map.hasLayer(m));
      if(!visible.length) return;
      map.fitBounds(L.featureGroup(visible).getBounds().pad(0.12));
    }
    document.getElementById('btnFit').addEventListener('click', fitAllVisible);

    document.getElementById('btnReset').addEventListener('click', ()=>{
      document.querySelectorAll('.catFilter').forEach(c=>c.checked=true);
      document.getElementById('onlyTop').checked=false;
      applyFilters(); fitAllVisible();
    });

    // ---- Geolocation (panel button) ----
    let meMarker = null, meCircle = null, myPos = null;
    function updateMyLocation(lat, lng, accuracy) {
      myPos = { lat, lng };
      const latlng = [lat, lng];
      if (!meMarker) {
        meMarker = L.marker(latlng, { title: "–ú–æ—è—Ç–∞ –ø–æ–∑–∏—Ü–∏—è" }).addTo(map).bindPopup("–¢–æ–≤–∞ —Å–∏ —Ç–∏ (GPS)");
      } else meMarker.setLatLng(latlng);
      if (!meCircle) {
        meCircle = L.circle(latlng, { radius: accuracy || 50, color: '#2563eb', fillColor: '#2563eb', fillOpacity: 0.15 }).addTo(map);
      } else {
        meCircle.setLatLng(latlng);
        meCircle.setRadius(accuracy || 50);
      }
      map.setView(latlng, 16, { animate: true });
      meMarker.openPopup();
    }
    document.getElementById('btnLocate').addEventListener('click', () => {
      if (!navigator.geolocation) { showToast("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è—Ç–∞ –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞."); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          updateMyLocation(latitude, longitude, accuracy);
          showToast("–ü–æ–∑–∏—Ü–∏—è—Ç–∞ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞.");
        },
        (err) => {
          showToast(err.code === 1 ? "–î–æ—Å—Ç—ä–ø—ä—Ç –¥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –µ –æ—Ç–∫–∞–∑–∞–Ω." :
                   err.code === 2 ? "–ü–æ–∑–∏—Ü–∏—è—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞." :
                                    "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤–∑–µ–º–∞–Ω–µ –Ω–∞ –ø–æ–∑–∏—Ü–∏—è.");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
      );
    });

    // ---- Collapsible behavior ----
    function isSmall(){ return window.innerWidth <= 820; }
    function setCollapsed(coll){
      const panel = document.getElementById('sidePanel');
      if(coll){
        panel.classList.add('collapsed');
        document.getElementById('collapseIcon').classList.remove('glyphicon-menu-up');
        document.getElementById('collapseIcon').classList.add('glyphicon-menu-down');
        document.getElementById('panelHeader').setAttribute('aria-expanded','false');
      }else{
        panel.classList.remove('collapsed');
        document.getElementById('collapseIcon').classList.remove('glyphicon-menu-down');
        document.getElementById('collapseIcon').classList.add('glyphicon-menu-up');
        document.getElementById('panelHeader').setAttribute('aria-expanded','true');
        panel.style.top = (isSmall() ? 'calc(84px + env(safe-area-inset-top))' : '10px');
      }
    }
    if(isSmall()){ setCollapsed(true); }
    ['touchstart','click'].forEach(evt=>{
      document.getElementById('panelHeader').addEventListener(evt, function(e){
        e.preventDefault();
        const isColl = document.getElementById('sidePanel').classList.contains('collapsed');
        setCollapsed(!isColl);
      }, {passive:false});
    });
    window.addEventListener('resize', function(){
      if(isSmall()){ setCollapsed(true); } else { setCollapsed(false); }
    });

    // Keep popups clear of the side panel on small screens + wire up current-location links
    map.on('popupopen', function(e){
      const panel = document.getElementById('sidePanel');
      if(isSmall() && !panel.classList.contains('collapsed')){
        const shift = Math.round(panel.offsetWidth * 0.48);
        map.panBy([shift, 0], {animate:true});
      }
      const el = e.popup.getElement();
      if(!el) return;
      $(el).find('.dir-cur').off('click').on('click', function(ev){
        ev.preventDefault();
        const mode = this.getAttribute('data-mode');
        const lat  = parseFloat(this.getAttribute('data-lat'));
        const lng  = parseFloat(this.getAttribute('data-lng'));
        if(!myPos){ showToast('–ü—ä—Ä–≤–æ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ ‚Äû–ù–∞–º–µ—Ä–∏ –º–µ‚Äú.'); return; }
        const href = gmapsUrl(myPos, {lat, lng}, mode);
        window.open(href, '_blank');
      });
    });

    // ---- Modal (kept) ----
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const modalClose = document.getElementById('modalClose');
    const tabButtons = () => Array.from(document.querySelectorAll('.tab-btn'));

    function openModal(name, infoHTML) {
      modalTitle.textContent = name;
      tabButtons().forEach(b => b.classList.toggle('active', b.dataset.tab === 'info'));
      renderTab('info', infoHTML);
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden', 'true');
    }
    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

    function renderTab(tab, infoHTML, pins, gimages) {
      if (tab === 'info') {
        modalContent.innerHTML = infoHTML;
      } else {
        const pinList = (pins || []).map(u => `<li><a href="${u}" target="_blank" rel="noopener">${u}</a></li>`).join('') || '<li>–ù—è–º–∞ –ø–æ–¥–±—Ä–∞–Ω–∏ –ª–∏–Ω–∫–æ–≤–µ.</li>';
        const gList = (gimages || []).map(u => `<li><a href="${u}" target="_blank" rel="noopener">${u}</a></li>`).join('') || '';
        modalContent.innerHTML = `
          <div style="font-size:14px;opacity:.9;margin-bottom:8px;">–ò–¥–µ–∏ –∑–∞ –∫–∞–¥—Ä–∏ –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:</div>
          <h4 style="margin:0 0 6px;">Pinterest</h4>
          <ul style="padding-left:18px">${pinList}</ul>
          <h4 style="margin:12px 0 6px;">Google Images (–∑–∞—è–≤–∫–∏)</h4>
          <ul style="padding-left:18px">${gList}</ul>
        `;
      }
    }
  </script>
</body>
</html>
